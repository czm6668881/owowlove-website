# 🚀 Google OAuth 完整设置指南

## ❌ 当前错误分析

您遇到的错误 "The OAuth client was not found" (错误401: invalid_client) 是因为：
- Google客户端ID还是默认值 `your-google-client-id-here`
- 需要在Google Cloud Console中创建真实的OAuth凭据

## 📋 准备工作

在开始之前，请确保您有：
- ✅ Google账号（Gmail账号）
- ✅ 网络连接
- ✅ 浏览器（推荐Chrome）
- ✅ 开发服务器正在运行（端口3001）

## 🎯 详细设置步骤

### 步骤1: 访问Google Cloud Console

1. **打开浏览器**
   - 访问：https://console.cloud.google.com/
   - 使用您的Google账号登录

2. **首次访问提示**
   - 如果是第一次使用，可能需要同意服务条款
   - 选择国家/地区（选择中国）
   - 点击"同意并继续"

### 步骤2: 创建新项目

1. **选择项目**
   - 在页面顶部，点击项目选择器（显示为"选择项目"或当前项目名）
   - 在弹出窗口中，点击右上角的"新建项目"

2. **填写项目信息**
   - 项目名称：`OWOWLOVE-OAuth`（或您喜欢的名称）
   - 组织：保持默认（无组织）
   - 位置：保持默认
   - 点击"创建"按钮

3. **等待项目创建**
   - 创建过程需要几秒钟
   - 创建完成后，确保选择了新创建的项目

### 步骤3: 启用必要的API

1. **进入API库**
   - 在左侧导航菜单中，找到"API和服务"
   - 点击"API和服务" → "库"

2. **搜索并启用API**
   - 在搜索框中输入："Google+ API"
   - 点击搜索结果中的"Google+ API"
   - 点击"启用"按钮
   - 等待API启用完成（通常几秒钟）

3. **备选方案**（如果找不到Google+ API）
   - 搜索："People API"
   - 启用"Google People API"

### 步骤4: 配置OAuth同意屏幕

1. **进入OAuth同意屏幕**
   - 在左侧菜单中，点击"API和服务" → "OAuth同意屏幕"

2. **选择用户类型**
   - 选择"外部"（External）
   - 点击"创建"按钮

3. **填写应用信息**（第1步：OAuth同意屏幕）
   - **应用名称**：`OWOWLOVE`
   - **用户支持电子邮件**：从下拉菜单选择您的邮箱
   - **应用徽标**：可选，暂时跳过
   - **应用首页**：`http://localhost:3001`
   - **应用隐私政策链接**：可选，暂时跳过
   - **应用服务条款链接**：可选，暂时跳过
   - **已获授权的网域**：暂时跳过
   - **开发者联系信息**：输入您的邮箱地址
   - 点击"保存并继续"

4. **配置范围**（第2步：范围）
   - 点击"添加或移除范围"按钮
   - 在弹出窗口中，找到并勾选以下范围：
     - `../auth/userinfo.email` - 查看您的电子邮件地址
     - `../auth/userinfo.profile` - 查看您的基本个人资料信息
   - 点击"更新"按钮
   - 确认范围已添加，点击"保存并继续"

5. **添加测试用户**（第3步：测试用户）
   - 点击"添加用户"按钮
   - 输入您要测试的邮箱地址（建议添加您自己的邮箱）
   - 点击"添加"
   - 点击"保存并继续"

6. **摘要确认**（第4步：摘要）
   - 检查所有信息是否正确
   - 点击"返回信息中心"

### 步骤5: 创建OAuth 2.0凭据

1. **进入凭据页面**
   - 在左侧菜单中，点击"API和服务" → "凭据"

2. **创建新凭据**
   - 点击页面顶部的"创建凭据"按钮
   - 从下拉菜单中选择"OAuth 2.0客户端ID"

3. **配置应用类型**
   - **应用类型**：选择"Web应用"
   - **名称**：输入 `OWOWLOVE Web Client`

4. **设置已获授权的重定向URI**
   - 在"已获授权的重定向URI"部分，点击"添加URI"
   - 输入以下URI（请确保完全一致）：
     ```
     http://localhost:3001/api/auth/google/callback
     ```
   - ⚠️ **重要**：确保端口号是3001，不是3000
   - ⚠️ **重要**：确保路径是 `/api/auth/google/callback`

5. **创建凭据**
   - 检查所有信息无误后，点击"创建"按钮

### 步骤6: 获取并保存凭据

1. **复制凭据信息**
   创建成功后，会弹出一个对话框显示：
   - **客户端ID**: 格式类似 `123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com`
   - **客户端密钥**: 格式类似 `GOCSPX-abcdefghijklmnopqrstuvwxyz`

2. **保存凭据**
   - 点击"下载JSON"按钮（可选，用于备份）
   - 或者直接复制客户端ID和客户端密钥
   - ⚠️ **重要**：请妥善保管这些凭据，不要泄露给他人

3. **关闭对话框**
   - 点击"确定"关闭对话框
   - 您可以随时在凭据页面查看这些信息

### 步骤7: 更新项目环境变量

1. **打开环境变量文件**
   - 在您的项目根目录中，找到 `.env.local` 文件
   - 使用文本编辑器打开该文件

2. **更新Google OAuth配置**
   找到以下行：
   ```env
   # Google OAuth Configuration
   GOOGLE_CLIENT_ID=your-google-client-id-here
   GOOGLE_CLIENT_SECRET=your-google-client-secret-here
   ```

   替换为您从Google Cloud Console获取的真实值：
   ```env
   # Google OAuth Configuration
   GOOGLE_CLIENT_ID=您复制的完整客户端ID
   GOOGLE_CLIENT_SECRET=您复制的完整客户端密钥
   ```

3. **示例格式**
   ```env
   # Google OAuth Configuration
   GOOGLE_CLIENT_ID=123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com
   GOOGLE_CLIENT_SECRET=GOCSPX-abcdefghijklmnopqrstuvwxyz
   ```

4. **保存文件**
   - 保存 `.env.local` 文件
   - ⚠️ **重要**：确保没有多余的空格或引号

### 步骤8: 重启开发服务器

1. **停止当前服务器**
   - 在运行开发服务器的终端中按 `Ctrl+C`（Windows/Linux）或 `Cmd+C`（Mac）
   - 等待服务器完全停止

2. **重新启动服务器**
   ```bash
   npm run dev
   ```

3. **确认服务器启动**
   - 等待看到类似信息：
   ```
   ✓ Ready in 1047ms
   - Local: http://localhost:3001
   ```

### 步骤9: 验证配置

1. **访问配置测试页面**
   - 打开浏览器
   - 访问：http://localhost:3001/en/test-google-oauth

2. **检查配置**
   - 点击"检查配置"按钮
   - 应该显示：✅ Google OAuth配置检查通过

3. **如果配置检查失败**
   - 检查环境变量是否正确设置
   - 确认开发服务器已重启
   - 检查客户端ID和密钥是否完整复制

## 🔍 完整测试流程

### 测试1: 配置验证

1. **访问测试页面**
   - 打开浏览器，访问：http://localhost:3001/en/test-google-oauth

2. **检查配置**
   - 点击"检查配置"按钮
   - 期望结果：✅ Google OAuth配置检查通过

3. **如果配置检查失败**
   - 检查环境变量是否正确设置
   - 确认开发服务器已重启
   - 验证客户端ID和密钥格式是否正确

### 测试2: Google登录流程

1. **访问登录页面**
   - 打开新标签页，访问：http://localhost:3001/en/login

2. **点击Google登录**
   - 找到"Continue with Google"按钮
   - 点击该按钮

3. **Google授权页面**
   - 应该重定向到Google的授权页面
   - 页面显示"使用Google账号登录"
   - 显示您的应用名称"OWOWLOVE"

4. **完成授权**
   - 选择您的Google账号（必须是测试用户列表中的账号）
   - 点击"继续"或"允许"
   - 授权应用访问您的基本信息和邮箱

5. **登录成功**
   - 应该重定向回您的网站
   - 显示登录成功页面或直接进入网站首页
   - 用户信息应该正确显示

### 测试3: 用户数据验证

1. **检查用户信息**
   - 登录成功后，检查用户名是否正确显示
   - 检查邮箱地址是否正确
   - 如果有头像，检查是否正确显示

2. **检查用户状态**
   - 确认用户已登录状态
   - 可以正常访问需要登录的页面
   - 登出功能正常工作

## ⚠️ 重要注意事项和限制

### 测试模式限制
1. **用户限制**
   - 在测试模式下，只有添加到"测试用户"列表的邮箱才能登录
   - 如果用户不在测试列表中，会看到"access_denied"错误
   - 最多可以添加100个测试用户

2. **应用状态**
   - 新创建的应用默认处于"测试"状态
   - 测试状态下的应用有使用限制
   - 要支持所有用户，需要发布应用（需要验证过程）

### 技术要求
1. **重定向URI匹配**
   - 重定向URI必须完全匹配：`http://localhost:3001/api/auth/google/callback`
   - 协议、域名、端口、路径都必须完全一致
   - 区分大小写

2. **环境变量格式**
   - 客户端ID格式：`数字-字符串.apps.googleusercontent.com`
   - 客户端密钥格式：`GOCSPX-字符串`
   - 不要添加引号或多余空格

3. **网络要求**
   - 需要稳定的网络连接
   - 某些网络环境可能需要科学上网
   - 确保可以访问Google服务

## 🆘 常见问题和解决方案

### 问题1: "The OAuth client was not found" (invalid_client)
**原因**: 客户端ID配置错误
**解决方案**:
1. 检查 `.env.local` 中的 `GOOGLE_CLIENT_ID` 是否正确
2. 确保客户端ID格式正确（包含 `.apps.googleusercontent.com`）
3. 重启开发服务器

### 问题2: "redirect_uri_mismatch"
**原因**: 重定向URI不匹配
**解决方案**:
1. 检查Google Console中的重定向URI设置
2. 确保URI是：`http://localhost:3001/api/auth/google/callback`
3. 注意端口号必须是3001

### 问题3: "access_denied"
**原因**: 用户不在测试用户列表中
**解决方案**:
1. 在Google Console的OAuth同意屏幕中添加测试用户
2. 确保使用的邮箱在测试用户列表中
3. 或者发布应用（需要验证过程）

### 问题4: 配置检查失败
**原因**: 环境变量未正确设置
**解决方案**:
1. 检查 `.env.local` 文件是否存在
2. 确保环境变量名称正确
3. 确保没有多余的空格或引号
4. 重启开发服务器

### 问题5: 网络连接问题
**原因**: 无法访问Google服务
**解决方案**:
1. 检查网络连接
2. 尝试访问 https://accounts.google.com 确认可以访问
3. 如果在中国大陆，可能需要科学上网

## 🔧 调试工具和方法

### 1. 使用浏览器开发者工具
- 按F12打开开发者工具
- 查看Network标签页的请求和响应
- 查看Console标签页的错误信息

### 2. 查看服务器日志
- 在运行开发服务器的终端中查看输出
- 注意任何错误或警告信息

### 3. 使用测试页面
- 访问：http://localhost:3001/en/test-google-oauth
- 使用配置检查功能
- 逐步测试每个组件

## 🎉 成功标志

当所有配置正确时，您应该看到：
1. ✅ 配置检查通过
2. ✅ 点击Google登录按钮后正确重定向
3. ✅ Google授权页面显示您的应用名称
4. ✅ 授权后成功登录并返回网站
5. ✅ 用户信息正确显示

完成这些步骤后，Google登录功能就可以正常工作了！🎉

## 📞 获取帮助

如果按照以上步骤仍然遇到问题，请：
1. 仔细检查每个配置步骤
2. 使用测试页面验证配置
3. 查看浏览器和服务器的错误日志
4. 确认网络连接正常
